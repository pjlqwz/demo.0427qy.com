(function($) {
    $.fn.DB_tabMotionBanner = function(options) {
        var defaults = {
            key: "",
            autoRollingTime: 3000,
            bgSpeed: 1000,
            motion: {}
        };
        var settings = $.extend({}, defaults, options);

        return this.each(function() {
            var $this = $(this);
            var $imgSet = $this.find(".DB_imgSet");
            var $imgList = $imgSet.find("li");
            var $menuSet = $this.find(".DB_menuSet");
            var $menuList = $menuSet.find("li");
            var $bgSet = $this.find(".DB_bgSet li");
            var $nextBtn = $this.find(".DB_next");
            var $prevBtn = $this.find(".DB_prev");
            var imgCount = $imgList.length;
            var currentIndex = 0;
            var intervalId;

            function init() {
                setupStyles();
                bindEvents();
                startAutoRolling();
            }

            function setupStyles() {
                $imgSet.css({ position: "relative" });
                $imgList.css({ position: "absolute", display: "none" });
                $imgList.eq(currentIndex).show();

                $imgList.each(function(index) {
                    var $img = $(this).find("img");
                    $img.each(function() {
                        var $thisImg = $(this);
                        var className = $thisImg.attr("class");
                        var motionData = settings.motion[className];

                        if (motionData) {
                            var initialLeft = parseInt($thisImg.css("left"), 10);
                            var initialTop = parseInt($thisImg.css("top"), 10);

                            $thisImg.data({
                                x2: initialLeft,
                                y2: initialTop,
                                x1: initialLeft + (motionData.left || 0),
                                y1: initialTop + (motionData.top || 0),
                                opacity: motionData.opacity || 1,
                                speed: motionData.speed || 400,
                                delay: motionData.delay || 0
                            });
                        }
                    });
                });
            }

            function bindEvents() {
                $this.on("mouseenter", function() {
                    clearInterval(intervalId);
                    $nextBtn.show();
                    $prevBtn.show();
                }).on("mouseleave", function() {
                    startAutoRolling();
                    $nextBtn.hide();
                    $prevBtn.hide();
                });

                $menuList.on("click", function() {
                    if ($(this).index() !== currentIndex) {
                        currentIndex = $(this).index();
                        updateBanner();
                    }
                }).on("mouseenter", function() {
                    var $img = $(this).find("img");
                    toggleImgSrc($img, "_off", "_on");
                }).on("mouseleave", function() {
                    if (currentIndex !== $(this).index()) {
                        var $img = $(this).find("img");
                        toggleImgSrc($img, "_on", "_off");
                    }
                });

                $nextBtn.on("click", function() {
                    currentIndex = (currentIndex + 1) % imgCount;
                    updateBanner();
                });

                $prevBtn.on("click", function() {
                    currentIndex = (currentIndex - 1 + imgCount) % imgCount;
                    updateBanner();
                });
            }

            function startAutoRolling() {
                intervalId = setInterval(function() {
                    currentIndex = (currentIndex + 1) % imgCount;
                    updateBanner();
                }, settings.autoRollingTime);
            }

            function updateBanner() {
                $imgList.each(function(index) {
                    var $thisImgList = $(this);
                    var $bg = $bgSet.eq(index);
                    var $menu = $menuList.eq(index);
                    var $imgs = $thisImgList.find("img");

                    if (index === currentIndex) {
                        $thisImgList.show();
                        $imgs.each(function() {
                            var $img = $(this);
                            var motionData = $img.data();

                            // 这里我们不再检查 $.browser，因为现代浏览器通常都能很好地处理 PNG 图片的透明度
                            // 如果你确实需要对旧版 IE 做特殊处理，你可能需要使用条件注释或其他服务器端检测方法来加载一个特定的样式表或脚本

                            $img.stop().delay(motionData.delay).queue(function(next) {
                                $img.css("display", "block");
                                next();
                            }).animate({
                                left: motionData.x1,
                                top: motionData.y1,
                                opacity: motionData.opacity
                            }, motionData.speed);
                        });

                        toggleImgSrc($menu.find("img"), "_off", "_on");
                        $menu.addClass("select");
                        $bg.stop(true, true).fadeIn(settings.bgSpeed);
                    } else {
                        $thisImgList.hide();
                        toggleImgSrc($menu.find("img"), "_on", "_off");
                        $menu.removeClass("select");
                        $bg.stop(true, true).fadeOut(settings.bgSpeed);
                    }
                });
            }

            function toggleImgSrc($img, offSuffix, onSuffix) {
                var src = $img.attr("src");
                if (src.indexOf(offSuffix) !== -1) {
                    $img.attr("src", src.replace(offSuffix, onSuffix));
                }
            }

            init();
        });
    };
})(jQuery);